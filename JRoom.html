<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Peer Squares</title>
  <style>
    body { font-family: sans-serif; }
    textarea { width: 100%; height: 100px; margin: 5px 0; }
    canvas { border: 1px solid black; margin-top: 10px; display: block; }
    button { margin: 5px 0; }
  </style>
</head>
<body>
  <h3>Local SDP (copy to peer)</h3>
  <textarea id="local"></textarea>

  <h3>Remote SDP (paste from peer)</h3>
  <textarea id="remote"></textarea>

  <button onclick="connect()">Set Remote Description</button>
  <button onclick="answer()">Create Answer</button>

  <canvas id="canvas" width="600" height="400"></canvas>

  <script>
    const pc = new RTCPeerConnection();
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const myId = crypto.randomUUID();
    const peers = {}; // id -> dot
    const dotSize = 15;

    const myDot = {
      id: myId,
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      color: '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0'),
      label: "You"
    };
    peers[myId] = myDot;

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (const id in peers) {
        const dot = peers[id];
        ctx.fillStyle = dot.color;
        ctx.fillRect(dot.x, dot.y, dotSize, dotSize);
        ctx.fillText(dot.label, dot.x + dotSize + 5, dot.y + 12);
      }
    }

    setInterval(draw, 100);

    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      myDot.x = x;
      myDot.y = y;
      send({ type: "move", id: myId, x, y });
    });

    function send(obj) {
      const data = JSON.stringify(obj);
      if (channel.readyState === "open") channel.send(data);
    }

    // Incoming data handler
    function handleMessage(e) {
      const msg = JSON.parse(e.data);
      if (msg.type === "hello") {
        msg.dot.label = "Peer";
        peers[msg.id] = msg.dot;
        send({ type: "hello", dot: myDot, id: myId });
      } else if (msg.type === "move") {
        if (peers[msg.id]) {
          peers[msg.id].x = msg.x;
          peers[msg.id].y = msg.y;
        }
      }
    }

    // Create data channel and handle connection
    const channel = pc.createDataChannel("chat");

    channel.onopen = () => {
      console.log("Channel open! Sending hello.");
      send({ type: "hello", dot: myDot, id: myId });
    };

    channel.onmessage = handleMessage;

    pc.ondatachannel = (event) => {
      event.channel.onmessage = handleMessage;
      event.channel.onopen = () => {
        console.log("Data channel opened by peer.");
        send({ type: "hello", dot: myDot, id: myId });
      };
    };

    // ICE & SDP handling
    pc.onicecandidate = (e) => {
      if (!e.candidate) {
        document.getElementById("local").value = JSON.stringify(pc.localDescription);
      }
    };

    pc.createOffer().then(offer => pc.setLocalDescription(offer));

    // Buttons
    window.connect = () => {
      const sdp = JSON.parse(document.getElementById("remote").value);
      pc.setRemoteDescription(new RTCSessionDescription(sdp));
    };

    window.answer = () => {
      pc.createAnswer().then(answer => {
        pc.setLocalDescription(answer).then(() => {
          document.getElementById("local").value = JSON.stringify(answer);
        });
      });
    };

    window.addEventListener("beforeunload", () => {
      if (channel.readyState === "open") {
        channel.send(JSON.stringify({ type: "bye", id: myId }));
      }
    });
  </script>
</body>
</html>
