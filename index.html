<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PK-SHH-DB OS v3.14 - Fixed Fullscreen Keyboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (all CSS remains unchanged) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (all HTML remains unchanged until fullscreen section) ... -->
    </div>

    <!-- Fullscreen overlay with the actual Ruffle player -->
    <div id="fullscreen-overlay">
        <div id="fullscreen-content">
            <div id="fullscreen-ruffle-container"></div>
            <div id="fullscreen-controls">
                <div class="control-btn" id="fs-screenshot-btn" title="Capture Screenshot">
                    <i class="fas fa-camera"></i>
                </div>
                <div class="control-btn" id="fs-tweet-btn" title="Share on Twitter">
                    <i class="fab fa-twitter"></i>
                </div>
                <div class="control-btn" id="fs-exit-btn" title="Exit Fullscreen">
                    <i class="fas fa-compress"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notification-text">Notification message</span>
    </div>

    <script>
        // DOM Elements
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        const ruffleContainer = document.getElementById('ruffle-container');
        const screenshotBtn = document.getElementById('screenshot-btn');
        const tweetBtn = document.getElementById('tweet-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        
        // Fullscreen elements
        const fullscreenOverlay = document.getElementById('fullscreen-overlay');
        const fullscreenRuffleContainer = document.getElementById('fullscreen-ruffle-container');
        const fsScreenshotBtn = document.getElementById('fs-screenshot-btn');
        const fsTweetBtn = document.getElementById('fs-tweet-btn');
        const fsExitBtn = document.getElementById('fs-exit-btn');
        
        // State
        let rufflePlayer = null;
        let currentGame = "init.vm";
        let originalControls = null;
        
        // Show notification
        function showNotification(message, isError = false) {
            notificationText.textContent = message;
            
            if (isError) {
                notification.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
            } else {
                notification.innerHTML = '<i class="fas fa-info-circle"></i> ' + message;
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Initialize Ruffle
        function initializeRuffle(gameFile = currentGame) {
            // Remove existing player if it exists
            if (rufflePlayer) {
                ruffleContainer.removeChild(rufflePlayer);
                rufflePlayer = null;
            }
            
            // Create Ruffle script if needed
            if (!window.RufflePlayer) {
                const script = document.createElement('script');
                script.src = 'https://accesslet.github.io/initLib.js';
                script.onload = () => setupRufflePlayer(gameFile);
                script.onerror = () => showNotification('Failed to load Ruffle library', true);
                document.head.appendChild(script);
            } else {
                setupRufflePlayer(gameFile);
            }
        }
        
        function setupRufflePlayer(gameFile) {
            if (!window.RufflePlayer) {
                showNotification('Ruffle library not loaded', true);
                return;
            }
            
            const ruffle = window.RufflePlayer.newest();
            if (!ruffle) {
                showNotification('Failed to initialize Ruffle player', true);
                return;
            }
            
            // Configure Ruffle with no branding and autoplay
            const config = {
                "autoplay": "on",
                "showRuffleLogo": false,
                "unmuteOverlay": "hidden",
                "backgroundColor": "#000000",
                "logLevel": "error",
                "showFullscreenButton": false,
                "warnOnUnsupportedContent": false,
                "contextMenu": "off",
                "allowNetworking": "all",
                "playerVersion": "0",
                "preferredRenderer": "canvas"
            };
            
            rufflePlayer = ruffle.createPlayer();
            rufflePlayer.config = config;
            rufflePlayer.id = "ruffle-player";
            ruffleContainer.appendChild(rufflePlayer);
            
            // Save reference to control buttons
            originalControls = document.querySelector('.control-buttons');
            
            // Load the game SWF
            rufflePlayer.load(gameFile);
            
            // Add terminal message
            addTerminalLine(`> Loading ${gameFile}...`);
            setTimeout(() => {
                addTerminalLine(`> ${gameFile} loaded successfully`);
            }, 1000);
        }
        
        // Add terminal line
        function addTerminalLine(text) {
            const terminal = document.querySelector('.terminal');
            const line = document.createElement('div');
            line.className = 'terminal-line';
            line.textContent = text;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        // Capture screenshot
        async function captureScreenshot(isFullscreen = false) {
            const container = isFullscreen ? fullscreenRuffleContainer : ruffleContainer;
            let player = container.querySelector('#ruffle-player');
            
            if (!player) {
                showNotification('Game not loaded', true);
                return null;
            }
            
            try {
                // Access the canvas element
                let canvas = null;
                if (player.shadowRoot) {
                    canvas = player.shadowRoot.querySelector('canvas');
                }
                
                if (!canvas) {
                    showNotification('Game canvas not found', true);
                    return null;
                }
                
                // Create a temporary canvas to capture the current frame
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                
                const context = tempCanvas.getContext('2d');
                context.fillStyle = '#000000';
                context.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                context.drawImage(canvas, 0, 0);
                
                // Convert canvas to data URL
                return tempCanvas.toDataURL('image/png');
            } catch (error) {
                console.error('Error capturing screenshot:', error);
                showNotification('Failed to capture screenshot', true);
                return null;
            }
        }
        
        // Save screenshot
        async function saveScreenshot(isFullscreen = false) {
            const dataUrl = await captureScreenshot(isFullscreen);
            
            if (!dataUrl) return;
            
            try {
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `SHH-DB-screenshot-${timestamp}.png`;
                
                link.href = dataUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Screenshot saved!');
            } catch (error) {
                console.error('Error saving screenshot:', error);
                showNotification('Failed to save screenshot', true);
            }
        }
        
        // Share on Twitter
        async function shareOnTwitter(isFullscreen = false) {
            const dataUrl = await captureScreenshot(isFullscreen);
            
            if (!dataUrl) {
                showNotification('No screenshot to share', true);
                return;
            }
            
            try {
                // Convert data URL to blob
                const response = await fetch(dataUrl);
                const blob = await response.blob();
                
                // Copy to clipboard
                await navigator.clipboard.write([
                    new ClipboardItem({
                        [blob.type]: blob
                    })
                ]);
                
                // Open Twitter intent
                const text = encodeURIComponent("Check this out everyone! From my PK-SHH-DB OS ðŸ¦‡");
                const twitterUrl = `https://twitter.com/intent/tweet?text=${text}`;
                window.open(twitterUrl, '_blank');
                
                showNotification('Image copied! Open Twitter to paste it.');
            } catch (err) {
                console.error('Failed to share on Twitter:', err);
                showNotification('Twitter share failed. Try saving the image first.', true);
            }
        }
        
        // Toggle fullscreen
        function toggleFullscreen() {
            if (!rufflePlayer) {
                showNotification('Game not loaded', true);
                return;
            }
            
            if (!fullscreenOverlay.style.display || fullscreenOverlay.style.display === 'none') {
                // Enter fullscreen mode
                fullscreenOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Move the existing Ruffle player to fullscreen container
                fullscreenRuffleContainer.appendChild(rufflePlayer);
                
                // Move control buttons to fullscreen
                const controls = document.querySelector('.control-buttons');
                if (controls) {
                    controls.style.position = 'fixed';
                    controls.style.top = '20px';
                    controls.style.right = '20px';
                    controls.style.zIndex = '10001';
                    document.body.appendChild(controls);
                }
                
                // Adjust player size
                rufflePlayer.style.width = '100%';
                rufflePlayer.style.height = '100%';
                
                showNotification('Entering fullscreen mode');
            } else {
                // Exit fullscreen mode
                fullscreenOverlay.style.display = 'none';
                document.body.style.overflow = '';
                
                // Move Ruffle player back to normal container
                ruffleContainer.appendChild(rufflePlayer);
                
                // Move controls back to original position
                const controls = document.querySelector('.control-buttons');
                if (controls && originalControls) {
                    controls.style.position = '';
                    controls.style.top = '';
                    controls.style.right = '';
                    controls.style.zIndex = '';
                    originalControls.appendChild(controls);
                }
                
                // Reset player size
                rufflePlayer.style.width = '';
                rufflePlayer.style.height = '';
                
                showNotification('Exiting fullscreen mode');
            }
        }
        
        // Game switching functionality
        function setupGameSwitching() {
            const menuItems = document.querySelectorAll('.menu-item');
            
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Update active item
                    menuItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Get game file from data attribute
                    const gameFile = this.getAttribute('data-nav');
                    currentGame = gameFile;
                    
                    // Update panel title
                    const panelTitle = document.querySelector('.panel-title');
                    panelTitle.textContent = this.textContent.trim().replace(/\n/g, '');
                    
                    // Load the selected game
                    initializeRuffle(gameFile);
                });
            });
        }
        
        // Initialize
        initializeRuffle();
        setupGameSwitching();
        
        // Event Listeners
        screenshotBtn.addEventListener('click', () => saveScreenshot(false));
        tweetBtn.addEventListener('click', () => shareOnTwitter(false));
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        
        // Fullscreen controls
        fsScreenshotBtn.addEventListener('click', () => saveScreenshot(true));
        fsTweetBtn.addEventListener('click', () => shareOnTwitter(true));
        fsExitBtn.addEventListener('click', toggleFullscreen);
        
        // Add terminal animation
        setTimeout(() => {
            addTerminalLine('> Scanning GCPD frequencies...');
            addTerminalLine('> Alert: Suspicious activity at Arkham Asylum');
            addTerminalLine('> Alert: Police scanners reporting armed robbery');
            addTerminalLine('> Deploying countermeasures...');
            addTerminalLine('> Situation contained');
        }, 2000);
    </script>
</body>
</html>
